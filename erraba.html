<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melih Uğur - Canlı Destek</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e5ddd5; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .chat-container { width: 350px; height: 500px; background: white; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.2); overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #efe7dd; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 14px; }
        .sent { align-self: flex-end; background: #dcf8c6; }
        .received { align-self: flex-start; background: white; }
        .input-area { padding: 10px; display: flex; gap: 5px; background: #f0f0f0; }
        input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        button { background: #128c7e; color: white; border: none; padding: 8px 15px; border-radius: 50%; cursor: pointer; }
        #login-overlay { position: absolute; width: 350px; height: 500px; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="chat-container">
    <div id="login-overlay">
        <h3>Melih'e Mesaj Yaz</h3>
        <input type="text" id="username" placeholder="İsminiz (Boşsa Anonim)">
        <button onclick="startChat()" style="border-radius: 5px; width: 100%; margin-top: 10px;">Sohbete Başla</button>
    </div>

    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="userMsg" placeholder="Mesaj yazın...">
        <button onclick="sendMessage()">➤</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB7UtwY8e-W_4NNn2RhouPdPItThmZev3A",
        authDomain: "melihgem-68f80.firebaseapp.com",
        databaseURL: "https://melihgem-68f80-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melihgem-68f80",
        storageBucket: "melihgem-68f80.firebasestorage.app",
        messagingSenderId: "916333092626",
        appId: "1:916333092626:web:1fdef33752a3dd4ac11dcb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let userId = "";

    window.startChat = async () => {
        let name = document.getElementById('username').value.trim();
        if (!name) {
            const result = await runTransaction(ref(db, 'anonimCount'), c => (c || 0) + 1);
            name = "Anonim-" + result.snapshot.val();
        }
        userId = name + "_" + Math.floor(Math.random() * 1000); // Benzersiz oda ID
        document.getElementById('login-overlay').style.display = 'none';
        
        // Mesajları dinle
        onChildAdded(ref(db, `chats/${userId}`), (data) => {
            const msg = data.val();
            const div = document.createElement('div');
            div.className = `msg ${msg.sender === 'admin' ? 'received' : 'sent'}`;
            div.innerText = msg.text;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
    };

    window.sendMessage = () => {
        const text = document.getElementById('userMsg').value;
        if (!text || !userId) return;
        push(ref(db, `chats/${userId}`), { sender: 'user', text: text, time: serverTimestamp() });
        document.getElementById('userMsg').value = "";
    };
</script>
</body>
</html>
